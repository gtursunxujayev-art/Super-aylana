// prisma/schema.prisma
// Safe for `prisma db push` on an existing database with legacy NULLs and rows.

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  USER
  ADMIN
}

model User {
  id            String         @id @default(cuid())

  // Keep optional for now so legacy rows with NULL are valid.
  tgId          String?        @unique

  // Keep optional and NOT unique for now; you can tighten later.
  username      String?
  passwordHash  String?

  balance       Int            @default(0)
  role          Role           @default(USER)

  createdAt     DateTime       @default(now())
  // Important: default(now()) allows adding this required column on a table with rows.
  updatedAt     DateTime       @updatedAt @default(now())

  // Relations
  spins         Win[]
  balanceEvents BalanceEvent[]
}

model Prize {
  id          String    @id @default(cuid())
  title       String
  coinCost    Int
  imageUrl    String?
  active      Boolean   @default(true)
  showInStore Boolean   @default(true)

  createdAt   DateTime  @default(now())
  // Important: default(now()) so the backfill works on existing 5 rows.
  updatedAt   DateTime  @updatedAt @default(now())

  wins        Win[]

  // Add later once data is clean:
  // @@unique([title, coinCost])
}

model Win {
  id         String    @id @default(cuid())

  userId     String
  user       User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  // May be null (e.g., “no prize / try again”)
  prizeId    String?
  prize      Prize?    @relation(fields: [prizeId], references: [id], onDelete: SetNull)

  title      String

  // Was failing because table already has 7 rows; give a default so the add is safe.
  tier       Int       @default(0)

  createdAt  DateTime  @default(now())
}

model BalanceEvent {
  id         String    @id @default(cuid())

  userId     String
  user       User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  delta      Int
  reason     String?
  createdAt  DateTime  @default(now())
}

// Keep legacy row valid by NOT forcing NOT NULL where NULLs already exist.
model SpinState {
  id           String    @id @default("global")
  status       String    @default("IDLE")     // IDLE | SPINNING

  // Optional with defaults so existing NULLs are OK and new rows have values.
  spinStartAt  DateTime? @default(now())
  durationMs   Int?      @default(0)
  tier         Int?      @default(0)

  // Optional “who / what” text fields with safe defaults
  userName     String    @default("")
  resultTitle  String    @default("")

  updatedAt    DateTime  @updatedAt @default(now())
}